{"version":3,"file":"sui-ads.umd.js","sources":["../src/index.ts"],"sourcesContent":["import type { SlotMeta } from \"@aquads/shared/src/types\";\n\nlet API_BASE = \"\"; // default same origin\nexport function setApiBase(base: string) {\n  API_BASE = base || \"\";\n}\n\nexport async function mount(el: HTMLElement, slotId: string) {\n  const s = await fetch(`${API_BASE}/api/slot/${slotId}/current`).then((r) => r.json());\n  const latest = s.latestMetaCid as string | null;\n  if (!latest) {\n    renderPlaceholder(el, \"No creative yet\");\n    return;\n  }\n  const meta = await fetchWalrusJSON(latest);\n  if (!verifySeal(meta)) {\n    renderPlaceholder(el, \"Rejected by policy\");\n    return;\n  }\n  enforceSize(el, meta.width, meta.height);\n  const img = new Image();\n  img.src = walrusToHttp(meta.img_cid);\n  img.style.width = \"100%\";\n  img.style.height = \"100%\";\n  img.style.objectFit = \"cover\";\n\n  const container = document.createElement(\"div\");\n  container.style.position = \"relative\";\n  container.style.width = \"100%\";\n  container.style.height = \"100%\";\n  container.appendChild(img);\n\n  // Small translucent corner label (can disable via window.__AQUADS_HIDE_LABEL = true)\n  const hideLabel = (window as any).__AQUADS_HIDE_LABEL === true || (window as any).__SUI_AD_HIDE_LABEL === true;\n  if (!hideLabel) {\n    const badge = document.createElement(\"div\");\n    badge.textContent = \"Ad by Aquads\";\n    badge.style.position = \"absolute\";\n    badge.style.right = \"6px\";\n    badge.style.bottom = \"6px\";\n    badge.style.padding = \"2px 6px\";\n    badge.style.font = \"10px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif\";\n    badge.style.color = \"#fff\";\n    badge.style.background = \"rgba(0,0,0,0.45)\";\n    badge.style.borderRadius = \"4px\";\n    badge.style.pointerEvents = \"none\";\n    badge.style.userSelect = \"none\";\n    container.appendChild(badge);\n  }\n\n  img.onload = () => {\n    img.onclick = () => {\n      fetch(`${API_BASE}/api/track/click`, {\n        method: \"POST\",\n        body: JSON.stringify({ slotId, url: meta.landing_url }),\n      }).catch(() => {});\n      window.location.href = meta.landing_url;\n    };\n  };\n  img.onerror = () => {\n    renderPlaceholder(el, \"Image failed to load\");\n  };\n  el.replaceChildren(container);\n  // Start viewability tracking once creative is in DOM\n  try {\n    startViewability(el, { slotId });\n  } catch {}\n}\n\nexport function renderPlaceholder(el: HTMLElement, text: string) {\n  el.innerHTML = `<div style=\"display:flex;align-items:center;justify-content:center;background:#f2f3f5;color:#666;border:1px dashed #ccc;width:100%;height:100%;font:12px sans-serif;\">${text}</div>`;\n}\n\nexport function enforceSize(el: HTMLElement, w: number, h: number) {\n  el.style.width = `${w}px`;\n  el.style.height = `${h}px`;\n}\n\nexport function walrusToHttp(cid: string) {\n  if (cid.startsWith(\"mock://\")) {\n    // Local mock: return uploads path if meta or image present; here we just echo cid\n    return `/uploads/${cid.replace(/^mock:\\/\\//, \"\")}`; // might not exist for images; used for demo\n  }\n  if (cid.startsWith(\"walrus://\")) {\n    return cid.replace(\"walrus://\", (window as any).WALRUS_HTTP_GATEWAY || \"https://walrus.testnet/ipfs/\");\n  }\n  return cid;\n}\n\nexport async function fetchWalrusJSON(metaCid: string): Promise<SlotMeta> {\n  if (metaCid.startsWith(\"mock://sha256-\")) {\n    const id = metaCid.replace(\"mock://sha256-\", \"\");\n    return fetch(`/uploads/${id}.json`).then((r) => r.json());\n  }\n  const url = walrusToHttp(metaCid);\n  return fetch(url).then((r) => r.json());\n}\n\nexport function verifySeal(meta: SlotMeta): boolean {\n  // MVP: mocked verification. Set window.__SEAL_DISABLE=true to bypass.\n  const disabled = (window as any).__SEAL_DISABLE === true;\n  if (disabled) return true;\n  // Basic checksum format check\n  return /^sha256:[0-9a-fA-F]{64}$/.test(meta.checksum);\n}\n\ndeclare global {\n  interface Window {\n    SuiAds: any;\n    __SEAL_DISABLE?: boolean;\n    WALRUS_HTTP_GATEWAY?: string;\n  }\n}\n\n// UMD export (provide both Aquads and legacy SuiAds aliases)\nconst __aquadsUMD = {\n  mount: (el: HTMLElement | string, opts: { slotId?: string } = {}) => {\n    const elem = typeof el === \"string\" ? (document.querySelector(el) as HTMLElement) : el;\n    const slotId = opts.slotId || elem?.dataset?.slotId || document.currentScript?.getAttribute(\"data-slot\") || \"\";\n    if (!elem || !slotId) return;\n    mount(elem, slotId);\n  },\n  setApiBase,\n};\n(window as any).Aquads = __aquadsUMD;\n(window as any).SuiAds = __aquadsUMD;\n\n// --- Viewability (Active View-like) ---\ntype ViewabilityOpts = { slotId: string; thresholdPct?: number; minDurationMs?: number };\nexport function startViewability(el: HTMLElement, opts: ViewabilityOpts) {\n  const thresholdPct = opts.thresholdPct ?? 0.5; // 50%\n  const minDurationMs = opts.minDurationMs ?? 1000; // 1s\n  let visibleRatio = 0;\n  let maxRatio = 0;\n  let accumMs = 0;\n  let lastTs = performance.now();\n  let pageVisible = document.visibilityState === \"visible\";\n  const thresholds = Array.from({ length: 21 }, (_, i) => i / 20);\n\n  const io = new IntersectionObserver(\n    (entries) => {\n      const e = entries[0];\n      visibleRatio = e.intersectionRatio;\n      if (visibleRatio > maxRatio) maxRatio = visibleRatio;\n    },\n    { root: null, threshold: thresholds }\n  );\n  io.observe(el);\n\n  const onVis = () => {\n    pageVisible = document.visibilityState === \"visible\";\n    lastTs = performance.now();\n  };\n  document.addEventListener(\"visibilitychange\", onVis);\n\n  const timer = setInterval(() => {\n    const now = performance.now();\n    const dt = now - lastTs;\n    lastTs = now;\n    if (pageVisible && visibleRatio >= thresholdPct) accumMs += dt;\n    if (accumMs >= minDurationMs) {\n      try {\n        const payload = {\n          slotId: opts.slotId,\n          maxPct: Math.round(maxRatio * 100),\n          durationMs: Math.round(accumMs),\n          ts: Date.now(),\n        };\n        navigator.sendBeacon?.(\n          `${API_BASE}/api/track/view`,\n          new Blob([JSON.stringify(payload)], { type: \"application/json\" })\n        ) ||\n          fetch(`${API_BASE}/api/track/view`, {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify(payload),\n          });\n      } catch {}\n      cleanup();\n    }\n  }, 250);\n\n  function cleanup() {\n    clearInterval(timer);\n    io.disconnect();\n    document.removeEventListener(\"visibilitychange\", onVis);\n  }\n  return { stop: cleanup };\n}\n"],"names":["API_BASE","setApiBase","base","async","mount","el","slotId","latest","fetch","then","r","json","latestMetaCid","renderPlaceholder","meta","fetchWalrusJSON","verifySeal","enforceSize","width","height","img","Image","src","walrusToHttp","img_cid","style","objectFit","container","document","createElement","position","appendChild","window","__AQUADS_HIDE_LABEL","__SUI_AD_HIDE_LABEL","badge","textContent","right","bottom","padding","font","color","background","borderRadius","pointerEvents","userSelect","onload","onclick","method","body","JSON","stringify","url","landing_url","catch","location","href","onerror","replaceChildren","startViewability","_a","text","innerHTML","w","h","cid","startsWith","replace","WALRUS_HTTP_GATEWAY","metaCid","id","__SEAL_DISABLE","test","checksum","__aquadsUMD","opts","elem","querySelector","dataset","_b","currentScript","getAttribute","thresholdPct","minDurationMs","visibleRatio","maxRatio","accumMs","lastTs","performance","now","pageVisible","visibilityState","thresholds","Array","from","length","_","i","io","IntersectionObserver","entries","e","intersectionRatio","root","threshold","observe","onVis","addEventListener","timer","setInterval","dt","payload","maxPct","Math","round","durationMs","ts","Date","navigator","sendBeacon","call","Blob","type","headers","cleanup","clearInterval","disconnect","removeEventListener","stop","Aquads","SuiAds"],"mappings":"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"}